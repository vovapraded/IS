databaseChangeLog:
  - changeSet:
      id: 007-fix-ownership-fk-constraints
      author: system
      comment: Fix circular dependency by changing ownership FK constraints from RESTRICT to SET NULL
      changes:
        # Удаляем существующие FK constraints с RESTRICT
        - dropForeignKeyConstraint:
            baseTableName: coordinates
            constraintName: fk_coordinates_owner_route
            
        - dropForeignKeyConstraint:
            baseTableName: locations
            constraintName: fk_locations_owner_route
            
        # Добавляем FK constraints с SET NULL для разрешения циклических зависимостей
        - addForeignKeyConstraint:
            constraintName: fk_coordinates_owner_route
            baseTableName: coordinates
            baseColumnNames: owner_route_id
            referencedTableName: routes
            referencedColumnNames: id
            onDelete: SET NULL
            onUpdate: CASCADE
            
        - addForeignKeyConstraint:
            constraintName: fk_locations_owner_route
            baseTableName: locations
            baseColumnNames: owner_route_id
            referencedTableName: routes
            referencedColumnNames: id
            onDelete: SET NULL
            onUpdate: CASCADE
            
      rollback:
        # Rollback - вернуть RESTRICT ограничения
        - dropForeignKeyConstraint:
            baseTableName: coordinates
            constraintName: fk_coordinates_owner_route
            
        - dropForeignKeyConstraint:
            baseTableName: locations
            constraintName: fk_locations_owner_route
            
        - addForeignKeyConstraint:
            constraintName: fk_coordinates_owner_route
            baseTableName: coordinates
            baseColumnNames: owner_route_id
            referencedTableName: routes
            referencedColumnNames: id
            onDelete: RESTRICT
            onUpdate: CASCADE
            
        - addForeignKeyConstraint:
            constraintName: fk_locations_owner_route
            baseTableName: locations
            baseColumnNames: owner_route_id
            referencedTableName: routes
            referencedColumnNames: id
            onDelete: RESTRICT
            onUpdate: CASCADE